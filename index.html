<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peinture — Galerie</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header class="top">

    <div class="top-row">
      <img src="logo-site.png" alt="Peinture" class="logo">
    </div>

    <!-- ✅ BANDEAU : boutons + nuancier -->
    <div class="nav-row">
      <div id="catButtons" class="catButtons"></div>

      <div class="nuancier-mini" id="nuancierBlock">
        <div>
          <img src="nuancier.png" alt="Nuancier couleurs">
          <p>Toutes nos couleurs sont teintées en magasin</p>
        </div>
      </div>


      <select id="catSelect" class="catSelect" aria-label="Choisir une catégorie"></select>


  </header>


  <div id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const IMAGES = {

      "levis": [
        "Amb.lak-sat.jpg",
        "Amb.lak.mat.jpg",
        "Amb.mur-extra-mat.jpg",
        "Amb.mur-metallic.jpg",
        "Amb.mur-satin.jpg",
        "Duo-sat-mix.jpg",
        "Easyclean-cuisine-sdb-mat.jpg",
        "Easyclean-cuisine-sdb-sat.jpg",
        "Easyclean-satin.jpg",
        "Expert-mur.jpg",
        "Ferro-decor.jpg",
        "Lak-exp-sat.jpg",
        "Lak-rapide-exter.jpg",
        "Lak-reg-sat.jpg",
        "Levis-floor-regul.jpg"
      ],

      "diessner": [
        "dry_protection.png",
        "premium.png",
        "primaire.png",
        "ultramatt.png",
        "perfect-fine.png"
      ],

      "sikkens": [
        "sikkens-filter-7-plus.jpg",
        "sikkens-filter-7.png",
        "sikkens-hsl-plus.png",
        "sikkens-novatech.png"
      ],

      "v33": [
        "bois-de-jardin.png",
        "huile-cire-escaliers.png",
        "huile-cire-parquet.png",
        "huile-plan-travail-mat.png",
        "huile-terrasse.png",
        "primer-bois.png",
        "protection.png",
        "sol-extreme.png",
        "vernis-meuble.png",
        "vernis-yacht.png",
        "vitrificateur-escaliers.png",
        "vitrificateur-parquet.png"
      ],

      "basin": [
        "aquadux.png",
        "cire-siccatif.png",
        "huile-maintenance.png",
        "huile-parquet-color.png",
        "intensive-cleaner.png",
        "nettoyant-wash-wax.png",
        "no-visible-huile.png",
        "vitrificateur-2-composants-acryl.png"
      ],

      "cecil": [
        "tx203.png"
      ],

      "motip": [
        "carat-argent.png",
        "carat-chrome-argent.png",
        "carat-chrome-cuivre.png",
        "carat-chrome-or.png",
        "carat-color.png",
        "carat-effet-paillettes-or.png",
        "carat-fixation.png",
        "carat-glue.png",
        "carat-polystyrene.png",
        "carat-primer-blanc.png",
        "carat-primer.png",
        "crafts-spray.png",
        "effect-bronze-antique.png",
        "effect-bronze-cuivre.png",
        "effect-bronze-gold.png",
        "effect-chrome-cuivre.png",
        "effect-chrome-gold.png",
        "effect-chrome.png",
        "effect-clear-varnish-vernis.png",
        "effect-email-porcelaine.png",
        "effect-fluor.png",
        "effect-frigo-blanc.png",
        "effect-graffiti-ex.png",
        "effect-metallic.png",
        "effect-radiateur.png",
        "effect-zinc.png",
        "karat-effet-paillettes.png",
        "motip-effect-ht.jpg",
        "spray-acryl.png",
        "spray-prof.png",
        "effect-primer-plastique.png",
        "effect-tableau.png",
        "carat-embout.png"
      ],

      "hammerite": [
        "600.png",
        "base.png",
        "color.png",
        "convertisseur-de-rouille.png",
        "decap-rouille.png",
        "degraisse-metal.png",
        "diluant-nettoyant-pinceau.png",
        "primer-beige.png",
        "primer-non-ferreux.png",
        "radiateur-blanc.png",
        "resistante-chaleur-noir.png",
        "structure.png",
        "ultima.png"
      ],
    };

    const DISPLAY_NAMES = {
      "levis/Amb.lak-sat.jpg": "Ambiance laque satin",
      "levis/Amb.lak.mat.jpg": "Ambiance laque mat",
      "levis/Amb.mur-extra-mat.jpg": "Ambiance mur extra mat",
      "levis/Amb.mur-metallic.jpg": "Ambiance mur metallic",
      "levis/Amb.mur-satin.jpg": "Ambiance mur satin",
      "levis/Duo-sat-mix.jpg": "Duo sat mix",
      "levis/Easyclean-cuisine-sdb-mat.jpg": "Easyclean cuisine/sdb mat",
      "levis/Easyclean-cuisine-sdb-sat.jpg": "Easyclean cuisine/sdb sat",
      "levis/Easyclean-satin.jpg": "Easyclean satin",
      "levis/Expert-mur.jpg": "Expert mur",
      "levis/Facade-exp-levis-mix.png": "Façade (mix)",
      "levis/Ferro-decor.jpg": "Ferro décor",
      "levis/Lak-exp-high-gloss.png": "Laque high gloss",
      "levis/Lak-exp-sat.jpg": "Laque exp satin",
      "levis/Lak-rapide-exter.jpg": "Laque rapide extérieur",
      "levis/Lak-reg-sat.jpg": "Laque rég satin",
      "levis/Levis-floor-regul.jpg": "Levis floor regul",

      "diessner/dry_protection.png": "Dry protection",
      "diessner/premium.png": "Premium",
      "diessner/primaire.png": "Primaire",
      "diessner/ultramatt.png": "Ultramatt",
      "diessner/perfect-fine.png": "Perfect fine",
      "sikkens/sikkens-filter-7-plus.jpg": "Filter 7 Plus",
      "sikkens/sikkens-filter-7.png": "Filter 7",
      "sikkens/sikkens-hsl-plus.png": "HSL Plus",
      "sikkens/sikkens-novatech.png": "Novatech",

      "v33/bois-de-jardin.png": "Bois de jardin",
      "v33/huile-cire-escaliers.png": "Huile cire escaliers",
      "v33/huile-cire-parquet.png": "Huile cire parquet",
      "v33/huile-plan-travail-mat.png": "Huile plan de travail mat",
      "v33/huile-terrasse.png": "Huile terrasse",
      "v33/primer-bois.png": "Primer bois",
      "v33/protection.png": "Protection",
      "v33/sol-extreme.png": "Sol extrême",
      "v33/vernis-meuble.png": "Vernis meuble",
      "v33/vernis-yacht.png": "Vernis yacht",
      "v33/vitrificateur-escaliers.png": "Vitrificateur escaliers",
      "v33/vitrificateur-parquet.png": "Vitrificateur parquet",

      "basin/aquadux.png": "Aquadux",
      "basin/cire-siccatif.png": "Cire siccatif",
      "basin/huile-maintenance.png": "Huile maintenance",
      "basin/huile-parquet-color.png": "Huile parquet color",
      "basin/intensive-cleaner.png": "Intensive cleaner",
      "basin/nettoyant-wash-wax.png": "Nettoyant wash wax",
      "basin/no-visible-huile.png": "No visible huile",
      "basin/vitrificateur-2-composants-acryl.png": "Vitrificateur 2 composants acryl",

      "cecil/tx203.png": "TX203 fongicide",

      "motip/carat-argent.png": "Carat Argent",
      "motip/carat-chrome-argent.png": "Carat Chrome Argent",
      "motip/carat-chrome-cuivre.png": "Carat Chrome Cuivre",
      "motip/carat-chrome-or.png": "Carat Chrome Or",
      "motip/carat-color.png": "Carat Color",
      "motip/carat-effet-paillettes-or.png": "Carat Effet Paillettes Or",
      "motip/carat-fixation.png": "Carat Fixation",
      "motip/carat-glue.png": "Carat Colle",
      "motip/carat-polystyrene.png": "Carat Polystyrène",
      "motip/carat-primer-blanc.png": "Carat Primer Blanc",
      "motip/carat-primer.png": "Carat Primer",
      "motip/carat-embout.png": "Embout / Buse",

      "motip/crafts-spray.png": "Craft Spray",

      "motip/effect-bronze-antique.png": "Effet Bronze Antique",
      "motip/effect-bronze-cuivre.png": "Effet Bronze Cuivre",
      "motip/effect-bronze-gold.png": "Effet Bronze Or",

      "motip/effect-chrome.png": "Effet Chrome",
      "motip/effect-chrome-cuivre.png": "Effet Chrome Cuivre",
      "motip/effect-chrome-gold.png": "Effet Chrome Or",

      "motip/effect-clear-varnish-vernis.png": "Vernis Transparent",
      "motip/effect-email-porcelaine.png": "Email Porcelaine",
      "motip/effect-fluor.png": "Fluorescent",
      "motip/effect-frigo-blanc.png": "Blanc Frigidaire",
      "motip/effect-graffiti-ex.png": "Graffiti EX",
      "motip/effect-metallic.png": "Métallique",
      "motip/effect-radiateur.png": "Radiateur",
      "motip/effect-zinc.png": "Zinc",

      "motip/karat-effet-paillettes.png": "Karat Effet Paillettes",
      "motip/motip-effect-ht.jpg": "Haute Température",

      "motip/spray-acryl.png": "Acrylique",
      "motip/spray-prof.png": "Profi Spray",

      "motip/effect-primer-plastique.png": "Primer Plastique",
      "motip/effect-tableau.png": "Tableau + Aimant",

      "hammerite/600.png": "Spray 600°",
      "hammerite/color.png": "Color",
      "hammerite/convertisseur-de-rouille.png": "Convertisseur de rouille",
      "hammerite/decap-rouille.png": "Décap’rouille",
      "hammerite/degraisse-metal.png": "Dégraisse métal",
      "hammerite/diluant-nettoyant-pinceau.png": "Diluant / nettoyant pinceau",
      "hammerite/primer-beige.png": "Primer beige",
      "hammerite/primer-non-ferreux.png": "Primer non ferreux",
      "hammerite/radiateur-blanc.png": "Radiateur blanc",
      "hammerite/resistante-chaleur-noir.png": "Résistante chaleur noir",
      "hammerite/structure.png": "Structure",
      "hammerite/ultima.png": "Ultima",

    };

    const PRODUCT_PDFS = {
      "diessner/dry_protection.png": "pdf/diessner-dry-protection.pdf",
      "diessner/perfect-fine.png": "pdf/diessner-perfect-fine.pdf",
      "diessner/premium.png": "pdf/diessner-premium.pdf",
      "diessner/primaire.png": "pdf/diessner-primaire.pdf",
      "diessner/ultramatt.png": "pdf/diessner-ultramatt.pdf",
      "sikkens/sikkens-filter-7-plus.jpg": "pdf/sikkens-filter-7-plus.pdf",
      "sikkens/sikkens-filter-7.png": "pdf/sikkens-filter-7.pdf",
      "sikkens/sikkens-hsl-plus.png": "pdf/sikkens-hsl-plus.pdf",
      "sikkens/sikkens-novatech.png": "pdf/sikkens-novatech.pdf",

      "v33/bois-de-jardin.png": "pdf/bois-de-jardin.pdf",
      "v33/huile-cire-escaliers.png": "pdf/huile-cire-escaliers.pdf",
      "v33/huile-cire-parquet.png": "pdf/huile-cire-parquet.pdf",
      "v33/huile-plan-travail-mat.png": "pdf/huile-plan-travail-mat.pdf",
      "v33/huile-terrasse.png": "pdf/huile-terrasse.pdf",
      "v33/primer-bois.png": "pdf/primer-bois.pdf",
      "v33/protection.png": "pdf/protection.pdf",
      "v33/sol-extreme.png": "pdf/sol-extreme.pdf",
      "v33/vernis-meuble.png": "pdf/vernis-meuble.pdf",
      "v33/vernis-yacht.png": "pdf/vernis-yacht.pdf",
      "v33/vitrificateur-escaliers.png": "pdf/vitrificateur-escaliers.pdf",
      "v33/vitrificateur-parquet.png": "pdf/vitrificateur-parquet.pdf",

      "basin/aquadux.png": "pdf/basin-aquadux.pdf",
      "basin/cire-siccatif.png": "pdf/basin-cire-siccatif.pdf",
      "basin/huile-maintenance.png": "pdf/basin-huile-maintenance.pdf",
      "basin/huile-parquet-color.png": "pdf/basin-huile-parquet-color.pdf",
      "basin/intensive-cleaner.png": "pdf/basin-intensive-cleaner.pdf",
      "basin/nettoyant-wash-wax.png": "pdf/basin-nettoyant-wash-wax.pdf",
      "basin/no-visible-huile.png": "pdf/basin-no-visible-huile.pdf",
      "basin/vitrificateur-2-composants-acryl.png": "pdf/basin-vitrificateur-2-composants-acryl.pdf",

      "levis/Amb.lak-sat.jpg": "pdf/levis-amb-lak-sat.pdf",
      "levis/Amb.lak.mat.jpg": "pdf/levis-amb-lak-mat.pdf",
      "levis/Amb.mur-extra-mat.jpg": "pdf/levis-amb-mur-extra-mat.pdf",
      "levis/Amb.mur-metallic.jpg": "pdf/levis-amb-mur-metallic.pdf",
      "levis/Amb.mur-satin.jpg": "pdf/levis-amb-mur-satin.pdf",
      "levis/Duo-sat-mix.jpg": "pdf/levis-duo-sat-mix.pdf",
      "levis/Easyclean-cuisine-sdb-mat.jpg": "pdf/levis-easyclean-cuisine-sdb-mat.pdf",
      "levis/Easyclean-cuisine-sdb-sat.jpg": "pdf/levis-easyclean-cuisine-sdb-sat.pdf",
      "levis/Easyclean-satin.jpg": "pdf/easyclean-satin.pdf",
      "levis/Expert-mur.jpg": "pdf/levis-expert-mur.pdf",
      "levis/Ferro-decor.jpg": "pdf/levis-ferro-decor.pdf",
      "levis/Lak-exp-sat.jpg": "pdf/levis-lak-exp-sat.pdf",
      "levis/Lak-rapide-exter.jpg": "pdf/levis-lak-rapide-exter.pdf",
      "levis/Lak-reg-sat.jpg": "pdf/levis-lak-reg-sat.pdf",
      "levis/Levis-floor-regul.jpg": "pdf/levis-floor-regul.pdf",

      "cecil/tx203.png": "pdf/tx203.pdf",

      "motip/carat-argent.png": "pdf/motip-carat-argent.pdf",
      "motip/carat-chrome-argent.png": "pdf/motip-carat-chrome-argent.pdf",
      "motip/carat-chrome-cuivre.png": "pdf/motip-carat-chrome-cuivre.pdf",
      "motip/carat-chrome-or.png": "pdf/motip-carat-chrome-or.pdf",
      "motip/carat-color.png": "pdf/motip-carat-color.pdf",
      "motip/carat-effet-paillettes-or.png": "pdf/motip-carat-effet-paillettes-or.pdf",
      "motip/carat-embout.png": "pdf/motip-carat-embout.pdf",
      "motip/carat-fixation.png": "pdf/motip-carat-fixation.pdf",
      "motip/carat-glue.png": "pdf/motip-carat-glue.pdf",
      "motip/carat-polystyrene.png": "pdf/motip-carat-polystyrene.pdf",
      "motip/carat-primer-blanc.png": "pdf/motip-carat-primer-blanc.pdf",
      "motip/carat-primer.png": "pdf/motip-carat-primer.pdf",
      "motip/crafts-spray.png": "pdf/motip-crafts-spray.pdf",

      "motip/effect-bronze-antique.png": "pdf/motip-effect-bronze-antique.pdf",
      "motip/effect-bronze-cuivre.png": "pdf/motip-effect-bronze-cuivre.pdf",
      "motip/effect-bronze-gold.png": "pdf/motip-effect-bronze-gold.pdf",
      "motip/effect-chrome-cuivre.png": "pdf/motip-effect-chrome-cuivre.pdf",
      "motip/effect-chrome-gold.png": "pdf/motip-effect-chrome-gold.pdf",
      "motip/effect-chrome.png": "pdf/motip-effect-chrome.pdf",
      "motip/effect-clear-varnish-vernis.png": "pdf/motip-effect-clear-varnish-vernis.pdf",
      "motip/effect-email-porcelaine.png": "pdf/motip-effect-email-porcelaine.pdf",
      "motip/effect-fluor.png": "pdf/motip-effect-fluor.pdf",
      "motip/effect-frigo-blanc.png": "pdf/motip-effect-frigo-blanc.pdf",
      "motip/effect-graffiti-ex.png": "pdf/motip-effect-graffiti-ex.pdf",
      "motip/effect-metallic.png": "pdf/motip-effect-metallic.pdf",
      "motip/effect-plastique.png": "pdf/motip-effect-plastique.pdf",
      "motip/effect-radiateur.png": "pdf/motip-effect-radiateur.pdf",
      "motip/effect-zinc.png": "pdf/motip-effect-zinc.pdf",

      "motip/karat-effet-paillettes.png": "pdf/motip-karat-effet-paillettes.pdf",
      "motip/motip-effet-ht.jpg": "pdf/motip-effet-haute-temperature.pdf",
      "motip/spray-acryl.png": "pdf/motip-spray-acryl.pdf",
      "motip/spray-prof.png": "pdf/motip-spray-prof.pdf",

      "hammerite/600.png": "pdf/hammerite-600.pdf",
      "hammerite/base.png": "pdf/hammerite-base.pdf",
      "hammerite/color.png": "pdf/hammerite-color.pdf",
      "hammerite/convertisseur-de-rouille.png": "pdf/hammerite-convertisseur-de-rouille.pdf",
      "hammerite/decap-rouille.png": "pdf/hammerite-decap-rouille.pdf",
      "hammerite/degraisse-metal.png": "pdf/hammerite-degraisse-metal.pdf",
      "hammerite/diluant-nettoyant-pinceau.png": "pdf/hammerite-diluant-nettoyant-pinceau.pdf",
      "hammerite/primer-beige.png": "pdf/hammerite-primer-beige.pdf",
      "hammerite/primer-non-ferreux.png": "pdf/hammerite-primer-non-ferreux.pdf",
      "hammerite/radiateur-blanc.png": "pdf/hammerite-radiateur-blanc.pdf",
      "hammerite/resistante-chaleur-noir.png": "pdf/hammerite-resistante-chaleur-noir.pdf",
      "hammerite/structure.png": "pdf/hammerite-structure.pdf",
      "hammerite/ultima.png": "pdf/hammerite-ultima.pdf",

    };

    const CAT_SIZES = {
      "levis": ["1L", "2.5L", "5L", "10L"],
      "diessner": ["1L", "2.5L", "5L", "10L"],
      "sikkens": ["1L", "2.5L", "5L"],
      "v33": ["0.5L", "1L", "2.5L", "5L"],
      "basin": ["1L", "2.5L", "5L"],
      "cecil": ["1L", "5L", "25L"],
      "motip": ["400ml"],
      "hammerite": [""],
    };

    const CATEGORY_UI = [
      { id: "levis", label: "Levis" },
      { id: "diessner", label: "Diessner" },
      { id: "sikkens", label: "Sikkens" },
      { id: "v33", label: "V33" },
      { id: "basin", label: "Basin" },
      { id: "cecil", label: "Cecil" },
      { id: "motip", label: "Motip Spray" },
      { id: "hammerite", label: "Hammerite" },

    ];

    const CAT_ICONS = {
      "levis": "vignettes-boutons/levis.png",
      "diessner": "vignettes-boutons/diessner.png",
      "sikkens": "vignettes-boutons/sikkens.png",
      "v33": "vignettes-boutons/v33.png",
      "basin": "vignettes-boutons/basin.png",
      "cecil": "vignettes-boutons/cecil.png",
      "motip": "vignettes-boutons/motip.png",
      "hammerite": "vignettes-boutons/hammerite.png",

    };

    const CAT_GROUPS = [
      { id: "paint", label: "Peintures", cats: ["levis", "diessner", "motip", "hammerite"] },
      { id: "wood", label: "Protections du bois", cats: ["sikkens", "v33", "basin", "cecil"] }
    ];

    const PRICE_MANIFEST_URL = "prix/manifest.json";
    let PRICE_MAP = Object.create(null);
    let STOCK_MAP = Object.create(null);
    let SIZES_BY_PATH = Object.create(null);

    // UI
    const app = document.getElementById("app");
    const catButtons = document.getElementById("catButtons");
    const catSelect = document.getElementById("catSelect");

    function normalizeSize(s) { return String(s || "").trim(); }
    function getKey(path, taille) { return `${path}|${normalizeSize(taille)}`; }

    function stockLabelFor(key) {
      const v = Number(STOCK_MAP[key]);
      return (v > 0) ? "✅ En stock" : "⚠️ Rupture";
    }

    function getSizeOptions(cat, file) {
      const pathKey = `${cat}/${file}`;

      // 1) Priorité aux tailles trouvées dans les Excel
      const excelSizes = SIZES_BY_PATH[pathKey];
      if (Array.isArray(excelSizes) && excelSizes.length) return excelSizes;

      // 2) Sinon fallback sur les tailles “en dur” du HTML
      return CAT_SIZES[cat] || [""];
    }


    function getStoredSize(key, fallback) {
      try {
        const v = localStorage.getItem("size:" + key);
        return v ? v : fallback;
      } catch { return fallback; }
    }
    function setStoredSize(key, val) {
      try { localStorage.setItem("size:" + key, val); } catch { }
    }

    function pickInitialSize(pathKey, options) {
      const stored = getStoredSize(pathKey, "");
      if (stored && options.includes(stored)) {
        const ks = getKey(pathKey, stored);
        const vs = Number(STOCK_MAP[ks]);
        if (vs > 0) return stored;
      }
      for (const opt of options) {
        const k = getKey(pathKey, opt);
        const v = Number(STOCK_MAP[k]);
        if (v > 0) return opt;
      }
      return options[0] || "";
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} sur ${url}`);
      return res.json();
    }

    async function fetchXlsxAsPriceMap(xlsxUrl) {
      const res = await fetch(xlsxUrl, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} sur ${xlsxUrl}`);

      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      if (!ws) throw new Error(`Feuille Excel introuvable dans ${xlsxUrl}`);

      const rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });

      const map = Object.create(null);
      const stock = Object.create(null);

      for (const r of rows) {
        let path = String(r.path || r.Path || r.PATH || "").trim();
        const taille = normalizeSize(r.taille ?? r.Taille ?? r.TAILLE ?? "");
        let price = r.prix_tvac ?? r.Prix_TVAC ?? r.PRIX_TVAC ?? r.prix ?? r.Prix ?? "";

        let stockRaw =
          r.disponible ?? r.Disponible ?? r.DISPO ?? r.dispo ?? r.stock ?? r.Stock ?? "";

        let stockVal = String(stockRaw).trim() === ""
          ? 0
          : Number(String(stockRaw).replace(",", "."));
        if (!Number.isFinite(stockVal)) stockVal = 0;

        if (!path) continue;
        path = path.replaceAll("\\", "/").replace(/^\.?\//, "");

        if (typeof price === "string") price = price.replace(",", ".").trim();
        const num = Number(price);

        if (Number.isFinite(num)) {
          const k = getKey(path, taille);
          map[k] = num;
          stock[k] = stockVal;
        }
      }

      return { map, stock };
    }

    function buildSizesByPath(priceMap) {
      const idx = Object.create(null);
      for (const k of Object.keys(priceMap)) {
        const sep = k.indexOf("|");
        if (sep === -1) continue;
        const pathKey = k.slice(0, sep);
        const taille = normalizeSize(k.slice(sep + 1));
        if (!pathKey || !taille) continue;
        if (/\.(png|jpg|jpeg|webp)$/i.test(taille)) continue;
        (idx[pathKey] ||= []).push(taille);
      }
      const collator = new Intl.Collator("fr", { numeric: true, sensitivity: "base" });
      for (const p of Object.keys(idx)) {
        const unique = Array.from(new Set(idx[p]));
        idx[p] = unique.sort((a, b) => collator.compare(String(a), String(b)));
      }
      return idx;
    }

    async function loadPricesFromFolder() {
      try {
        const files = await fetchJson(PRICE_MANIFEST_URL);
        if (!Array.isArray(files) || files.length === 0) throw new Error("manifest vide ou invalide");

        const merged = Object.create(null);
        const mergedStock = Object.create(null);

        for (const fname of files) {
          const url = `prix/${fname}`;
          try {
            const { map, stock } = await fetchXlsxAsPriceMap(url);
            for (const k of Object.keys(map)) merged[k] = map[k];
            for (const k of Object.keys(stock)) mergedStock[k] = stock[k];
          } catch (e) {
            console.warn("Fichier prix ignoré:", url, e);
          }
        }

        PRICE_MAP = merged;
        STOCK_MAP = mergedStock;
        SIZES_BY_PATH = buildSizesByPath(PRICE_MAP);

      } catch (e) {
        PRICE_MAP = Object.create(null);
        STOCK_MAP = Object.create(null);
        SIZES_BY_PATH = Object.create(null);
        console.warn("Prix non chargés (OK tant que le manifest n'existe pas):", e);
      }
    }

    function formatPrice(v) {
      if (!Number.isFinite(v)) return "";
      return (Math.round(v * 100) / 100).toFixed(2);
    }

    const categories = CATEGORY_UI.filter(c => IMAGES[c.id]);
    let activeCat = categories[0]?.id || "__none__";

    function buildCatButtons() {
      const catById = Object.fromEntries(categories.map(c => [c.id, c]));
      const mkBtn = (c) => {
        const icon = CAT_ICONS[c.id];
        return `
      <button class="catBtn ${c.id === activeCat ? 'active' : ''}" data-cat="${c.id}" type="button">
        ${icon ? `<div class="catIcon"><img src="${icon}" alt=""></div>` : ``}
        <span>${c.label}</span>
      </button>
    `;
      };

      catButtons.innerHTML = CAT_GROUPS.map(g => {
        const list = g.cats.map(id => catById[id]).filter(Boolean);
        if (!list.length) return "";
        return `
      <div class="catGroup" data-group="${g.id}">
        <div class="catGroupTitle">${g.label}</div>
        <div class="catGroupRow">
          ${list.map(mkBtn).join("")}
        </div>
      </div>
    `;
      }).join("");

      catButtons.querySelectorAll("button[data-cat]").forEach(btn => {
        btn.addEventListener("click", () => {
          activeCat = btn.dataset.cat;
          syncCategoryUI();
          render();
        });
      });
    }

    function buildCatSelect() {
      const catById = Object.fromEntries(categories.map(c => [c.id, c]));

      catSelect.innerHTML = CAT_GROUPS.map(g => {
        const list = g.cats.map(id => catById[id]).filter(Boolean);
        if (!list.length) return "";
        return `
      <optgroup label="${g.label}">
        ${list.map(c => `<option value="${c.id}">${c.label}</option>`).join("")}
      </optgroup>
    `;
      }).join("");

      catSelect.addEventListener("change", () => {
        activeCat = catSelect.value;
        syncCategoryUI();
        render();
      });
    }


    function syncCategoryUI() {
      if (catSelect) catSelect.value = activeCat;

      document.querySelectorAll("#catButtons .catBtn").forEach(b => {
        b.classList.toggle("active", b.dataset.cat === activeCat);
      });

      // ✅ gestion nuancier conditionnelle
      const nuancier = document.getElementById("nuancierBlock");
      if (nuancier) {
        nuancier.style.display =
          (activeCat === "levis" || activeCat === "diessner")
            ? "flex"
            : "none";
      }
    }


    function render() {
      const cat = activeCat;
      if (!cat || !IMAGES[cat]) {
        app.innerHTML = `<p class="muted">Aucune catégorie à afficher.</p>`;
        return;
      }

      const files = IMAGES[cat] || [];
      if (!files.length) {
        app.innerHTML = `<p class="muted">Aucun produit à afficher.</p>`;
        return;
      }

      let html = `<div class="grid">`;

      for (const f of files) {
        const pathKey = `${cat}/${f}`;
        const src = `${cat}/${encodeURIComponent(f)}`;

        const label = (DISPLAY_NAMES[pathKey] ?? f)
          .replace(/\.(png|jpg|jpeg|webp)$/i, "")
          .replace(/[-_]/g, " ");

        const options = (SIZES_BY_PATH[pathKey] && SIZES_BY_PATH[pathKey].length)
          ? SIZES_BY_PATH[pathKey]
          : getSizeOptions(cat, f);

        const currentSize = pickInitialSize(pathKey, options);
        setStoredSize(pathKey, currentSize);

        const k = getKey(pathKey, currentSize);
        const price = PRICE_MAP[k];
        const stockText = stockLabelFor(k);

        const selectId = "s_" + btoa(pathKey).replace(/=+/g, '');
        const stockId = "st_" + btoa(pathKey).replace(/=+/g, '');

        html += `
          <figure>
            <figcaption>
  ${PRODUCT_PDFS[pathKey]
            ? `<a href="${PRODUCT_PDFS[pathKey]}" target="_blank" rel="noopener" class="titleLink">
         ${label} <span class="pdfTag">PDF</span>
       </a>`
            : label
          }
</figcaption>




            <a class="thumb"
   href="${PRODUCT_PDFS[pathKey] ?? src}"
   target="_blank"
   rel="noopener">

              <img src="${src}" alt="${label}"
                onerror="this.style.display='none'; this.closest('figure').insertAdjacentHTML('beforeend','<div class=\\'missing\\'>❌ Introuvable : ${src}</div>')">
            </a>

            <div class="stock" id="${stockId}">${stockText}</div>

            <div class="size">
              <select id="${selectId}" data-path="${pathKey}" data-stock-id="${stockId}">
                ${options.map(o => `<option value="${o}" ${o === currentSize ? 'selected' : ''}>${o}</option>`).join("")}
              </select>
            </div>

            <div class="price">
              <div class="price-label">Tvac</div>
              ${price !== undefined
            ? `<div class="price-amount">
                     <span class="int">${formatPrice(price).split(".")[0]}</span>
                     <span class="dec">${formatPrice(price).split(".")[1] || "00"}</span>
                     <span class="eur">€</span>
                   </div>`
            : `<div class="price-amount muted">—</div>`
          }
            </div>
          </figure>
        `;
      }

      html += `</div>`;
      app.innerHTML = html;

      document.querySelectorAll('select[data-path]').forEach(sel => {
        sel.addEventListener("change", () => {
          const pathKey = sel.dataset.path;
          const taille = normalizeSize(sel.value);
          setStoredSize(pathKey, taille);

          const k = getKey(pathKey, taille);
          const price = PRICE_MAP[k];

          const figure = sel.closest("figure");
          const priceBox = figure ? figure.querySelector(".price") : null;

          if (priceBox) {
            if (price !== undefined) {
              const s = formatPrice(price);
              const [intPart, decPart = "00"] = s.split(".");
              priceBox.innerHTML = `
                <div class="price-label">Tvac</div>
                <div class="price-amount">
                  <span class="int">${intPart}</span>
                  <span class="dec">${decPart}</span>
                  <span class="eur">€</span>
                </div>
              `;
            } else {
              priceBox.innerHTML = `
                <div class="price-label">Tvac</div>
                <div class="price-amount muted">—</div>
              `;
            }
          }

          const stockId = sel.dataset.stockId;
          const st = document.getElementById(stockId);
          if (st) st.textContent = stockLabelFor(k);
        });
      });
    }

    (async function init() {
      try {
        await loadPricesFromFolder(); // OK même si pas encore de manifest
        buildCatButtons();
        buildCatSelect();
        syncCategoryUI();
        render();
      } catch (e) {
        console.error("Init error:", e);
        app.innerHTML = `<p class="missing">❌ Erreur JavaScript: ${String(e && e.message ? e.message : e)}</p>`;
      }
    })();
  </script>
</body>

</html>